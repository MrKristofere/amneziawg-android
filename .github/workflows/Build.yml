name: Build and Release APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v5
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-disabled: false
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build signed release APK
      run: |
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π keystore –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
        keytool -genkeypair \
          -v \
          -keystore temporary.keystore \
          -alias androidkey \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android \
          -keypass android \
          -dname "CN=Android Debug, O=Android, C=US"
          
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$(pwd)/temporary.keystore \
          -Pandroid.injected.signing.store.password=android \
          -Pandroid.injected.signing.key.alias=androidkey \
          -Pandroid.injected.signing.key.password=android

    - name: Find and verify APK
      run: |
        echo "üîç –ü–æ–∏—Å–∫ APK —Ñ–∞–π–ª–æ–≤..."
        find . -name "*.apk" -type f -exec ls -la {} \;
        
        # –ò—â–µ–º release APK
        APK_PATH=$(find . -name "*release*.apk" -type f | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå Release APK –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        
        echo "‚úÖ –ù–∞–π–¥–µ–Ω APK: $APK_PATH"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å APK
        echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ APK..."
        apksigner verify --verbose "$APK_PATH" || echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: apksigner –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º
        mv "$APK_PATH" "amneziawg-android-signed.apk"
        echo "üì¶ APK –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω: amneziawg-android-signed.apk"

    - name: Create Release via GitHub API
      run: |
        curl -L \
        -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        https://api.github.com/repos/${{ github.repository }}/releases \
        -d '{
          "tag_name": "v${{ github.run_number }}",
          "name": "v${{ github.run_number }}", 
          "body": "## üì± –ü–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è AmneziaWG Android\n\n**–í–ê–ñ–ù–û**: –≠—Ç–æ—Ç APK –ø–æ–¥–ø–∏—Å–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–º –∫–ª—é—á–æ–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.",
          "draft": false,
          "prerelease": false
        }'
