name: Build and Release APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v5
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-disabled: false
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build signed release APK
      run: |
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π keystore –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
        keytool -genkeypair \
          -v \
          -keystore temporary.keystore \
          -alias androidkey \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android \
          -keypass android \
          -dname "CN=Android Debug, O=Android, C=US"
          
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$(pwd)/temporary.keystore \
          -Pandroid.injected.signing.store.password=android \
          -Pandroid.injected.signing.key.alias=androidkey \
          -Pandroid.injected.signing.key.password=android

    - name: Find and verify APK
      run: |
        echo "üîç –ü–æ–∏—Å–∫ APK —Ñ–∞–π–ª–æ–≤..."
        find . -name "*.apk" -type f -exec ls -la {} \;
        
        # –ò—â–µ–º release APK
        APK_PATH=$(find . -name "*release*.apk" -type f | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå Release APK –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        
        echo "‚úÖ –ù–∞–π–¥–µ–Ω APK: $APK_PATH"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å APK
        echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ APK..."
        apksigner verify --verbose "$APK_PATH" || echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: apksigner –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º
        mv "$APK_PATH" "amneziawg-android-signed.apk"
        echo "üì¶ APK –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω: amneziawg-android-signed.apk"

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v5
      with:
        name: amneziawg-android-signed
        path: amneziawg-android-signed.apk
        retention-days: 30

    - name: Get version from tag
      if: startsWith(github.ref, 'refs/tags/')
      id: get_version
      run: |
        if [[ ${{ github.ref }} == refs/tags/* ]]; then
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG_NAME" >> $GITHUB_ENV
        else
          echo "TAG=v${{ github.run_number }}" >> $GITHUB_ENV
        fi

    - name: Create Release (only on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: ncipollo/release-action@v1
      with:
        artifacts: "amneziawg-android-signed.apk"
        tag: "${{ env.TAG }}"
        name: "AmneziaWG Android ${{ env.TAG }}"
        body: |
          ## üì± –ü–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è AmneziaWG Android
          **–í–ê–ñ–ù–û**: –≠—Ç–æ—Ç APK –ø–æ–¥–ø–∏—Å–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–º –∫–ª—é—á–æ–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
        draft: false
        prerelease: false
        allowUpdates: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
